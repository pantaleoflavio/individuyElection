# Usa un'immagine di base con PHP 8.1.17 e Apache 2.4
FROM php:8.1.17-apache

# Installa i pacchetti necessari
RUN apt-get update && apt-get install -y \
    npm \
    nodejs \
    libapache2-mod-php8.1 \
    php8.1-mysql \
    php8.1-mbstring \
    php8.1-xml \
    php8.1-curl \
    composer \
    mariadb-server \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Installa le dipendenze JavaScript
WORKDIR /var/www/html
COPY package.json package-lock.json /var/www/html/
RUN npm install

# Installa le dipendenze PHP
COPY composer.json composer.lock /var/www/html/
RUN composer install --no-dev --optimize-autoloader

# Copia il codice dell'applicazione
COPY . /var/www/html

# Configura le variabili d'ambiente (es. .env)
# COPY .env.example /var/www/html/.env
# RUN php artisan key:generate

# Esponi le porte necessarie
EXPOSE 80 3306

# Installa il server MariaDB
RUN apt-get update && apt-get install -y \
    mariadb-server \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Esponi la porta del database
EXPOSE 3306

# Avvia il server MariaDB
CMD ["service", "mysql", "start"]

# Riavvia Apache per applicare le modifiche
CMD ["apachectl", "-D", "FOREGROUND"]
